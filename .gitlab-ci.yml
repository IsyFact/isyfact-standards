include:
  - project: 'IsyFact/isy-gitlabci-templates'
    file: '/maven/.gitlab-ci-maven.yml'

build:
  extends: .maven-build

build:doc:
  extends: .maven-build
  variables:
    MAVEN_BUILD_OPTS: -pl isy-service-rest,isy-sst-bridge/bridge-documentation -Pbuild-docs,build-bridge-guide
  artifacts:
    expire_in: 1 day
    paths:
      - '**/target/doc/**'
      - '**/target/IsyFact-Bridge_Guide/**'

test:isy-aufrufkontext:
  extends: .maven-test

test:isy-batchrahmen:
  extends: .maven-test

test:isy-datetime:
  extends: .maven-test

test:isy-exception-core:
  extends: .maven-test

test:isy-exception-sst:
  extends: .maven-test

test:isy-konfiguration:
  extends: .maven-test

test:isy-logging:
  extends: .maven-test

test:isy-persistence:
  extends: .maven-test

test:isy-polling:
  extends: .maven-test

test:isy-serviceapi-core:
  extends: .maven-test

test:isy-serviceapi-sst:
  extends: .maven-test

test:isy-sicherheit:
  extends: .maven-test

test:isy-sonderzeichen:
  extends: .maven-test

test:isy-sst-bridge:
  extends: .maven-test

test:isy-sst-bridge/isy-exception-sst-bridge:
  extends: .maven-test

test:isy-sst-bridge/isy-serviceapi-sst-bridge:
  extends: .maven-test

test:isy-sst-bridge/isy-serviceapi-core-bridge:
  extends: .maven-test

test:isy-task:
  extends: .maven-test

test:isy-ueberwachung:
  extends: .maven-test

test:isy-util:
  extends: .maven-test

package:
  extends: .maven-package

deploy-snapshot:
  extends: .maven-deploy-snapshot

deploy:
  extends: .maven-deploy
  script:
    - 'if [[ -z $DEPLOYURL_RELEASE || -z $DEPLOYURL_SNAPSHOT ]] ; then echo "DEPLOY_URLs not found. Stopping deployment..."; exit 66 ; fi'
    - >
      mvn -s $ISY_MAVEN_SETTINGS $MAVEN_CLI_OPTS $MAVEN_DEPLOY_OPTS org.honton.chas:exists-maven-plugin:0.7.0:remote
      -Dexists.failIfExists=true
      -Dexists.skipIfSnapshot=true
      -Dexists.repository=${EXISTS_RELEASE_REPO}
      -Dexists.snapshotRepository=${EXISTS_SNAPSHOT_REPO}
      -Dexists.serverId=${EXISTS_RELEASE_REPO_ID}
      -Dexists.snapshotServerId=${EXISTS_SNAPSHOT_REPO_ID}
      -Drevision=$NEXT_VERSION
    - '[[ "$MAVEN_INSTALL_DEPENDENCIES" = "true" ]] && mvn -s $ISY_MAVEN_SETTINGS $MAVEN_CLI_OPTS $MAVEN_DEPLOY_OPTS -am -Drevision=$NEXT_VERSION clean install -DskipTests'
    - echo "$GPG_PRIVATE_KEY" | gpg --batch --import
    - >
      mvn -s $ISY_MAVEN_SETTINGS 
      -Dtidy.skip=true 
      -Dmaven.test.skip=true 
      -DskipTests 
      -Dmaven.install.skip=true 
      -DdeployAtEnd=true 
      -Drevision=$NEXT_VERSION 
      $MAVEN_CLI_OPTS 
      $MAVEN_DEPLOY_OPTS 
      -P GPGsigning -Dgpg.keyname="${GPG_KEYNAME}" -Dgpg.passphrase="${GPG_PASSPHRASE}" 
      cyclonedx:makeBom 
      deploy

stages:
  - build
  - test
  - package
  - deploy
